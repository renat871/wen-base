{"ast":null,"code":"import _createForOfIteratorHelper from \"D:/projects/react/wen-base/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport _regeneratorRuntime from \"D:/projects/react/wen-base/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _toConsumableArray from \"D:/projects/react/wen-base/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";\nimport _classCallCheck from \"D:/projects/react/wen-base/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"D:/projects/react/wen-base/node_modules/@babel/runtime/helpers/esm/createClass.js\";\n/*\nThis file is part of web3.js.\n\nweb3.js is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nweb3.js is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with web3.js.  If not, see <http://www.gnu.org/licenses/>.\n*/\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nimport { jsonRpc, Web3DeferredPromise } from 'web3-utils';\nimport { OperationAbortError, OperationTimeoutError, ResponseError } from 'web3-errors';\nexport var DEFAULT_BATCH_REQUEST_TIMEOUT = 1000;\nexport var Web3BatchRequest = /*#__PURE__*/function () {\n  function Web3BatchRequest(requestManager) {\n    _classCallCheck(this, Web3BatchRequest);\n    this._requestManager = requestManager;\n    this._requests = new Map();\n  }\n  _createClass(Web3BatchRequest, [{\n    key: \"requests\",\n    get: function get() {\n      return _toConsumableArray(this._requests.values()).map(function (r) {\n        return r.payload;\n      });\n    }\n  }, {\n    key: \"add\",\n    value: function add(request) {\n      var payload = jsonRpc.toPayload(request);\n      var promise = new Web3DeferredPromise();\n      this._requests.set(payload.id, {\n        payload: payload,\n        promise: promise\n      });\n      return promise;\n    }\n    // eslint-disable-next-line class-methods-use-this\n  }, {\n    key: \"execute\",\n    value: function execute(options) {\n      var _a;\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var _this = this;\n        var request;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              if (!(this.requests.length === 0)) {\n                _context.next = 2;\n                break;\n              }\n              return _context.abrupt(\"return\", Promise.resolve([]));\n            case 2:\n              request = new Web3DeferredPromise({\n                timeout: (_a = options === null || options === void 0 ? void 0 : options.timeout) !== null && _a !== void 0 ? _a : DEFAULT_BATCH_REQUEST_TIMEOUT,\n                eagerStart: true,\n                timeoutMessage: 'Batch request timeout'\n              });\n              this._processBatchRequest(request).catch(function (err) {\n                return request.reject(err);\n              });\n              request.catch(function (err) {\n                if (err instanceof OperationTimeoutError) {\n                  _this._abortAllRequests('Batch request timeout');\n                }\n                request.reject(err);\n              });\n              return _context.abrupt(\"return\", request);\n            case 6:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee, this);\n      }));\n    }\n  }, {\n    key: \"_processBatchRequest\",\n    value: function _processBatchRequest(promise) {\n      var _a, _b;\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n        var response, requestIds, responseIds, _iterator, _step, res;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return this._requestManager.sendBatch(_toConsumableArray(this._requests.values()).map(function (r) {\n                return r.payload;\n              }));\n            case 2:\n              response = _context2.sent;\n              if (!(response.length !== this._requests.size)) {\n                _context2.next = 6;\n                break;\n              }\n              this._abortAllRequests('Invalid batch response');\n              throw new ResponseError(response, \"Batch request size mismatch the results size. Requests: \".concat(this._requests.size, \", Responses: \").concat(response.length));\n            case 6:\n              requestIds = this.requests.map(function (r) {\n                return r.id;\n              }).map(Number).sort(function (a, b) {\n                return a - b;\n              });\n              responseIds = response.map(function (r) {\n                return r.id;\n              }).map(Number).sort(function (a, b) {\n                return a - b;\n              });\n              if (!(JSON.stringify(requestIds) !== JSON.stringify(responseIds))) {\n                _context2.next = 11;\n                break;\n              }\n              this._abortAllRequests('Invalid batch response');\n              throw new ResponseError(response, \"Batch request mismatch the results. Requests: [\".concat(requestIds.join(), \"], Responses: [\").concat(responseIds.join(), \"]\"));\n            case 11:\n              _iterator = _createForOfIteratorHelper(response);\n              try {\n                for (_iterator.s(); !(_step = _iterator.n()).done;) {\n                  res = _step.value;\n                  if (jsonRpc.isResponseWithResult(res)) {\n                    (_a = this._requests.get(res.id)) === null || _a === void 0 ? void 0 : _a.promise.resolve(res.result);\n                  } else if (jsonRpc.isResponseWithError(res)) {\n                    (_b = this._requests.get(res.id)) === null || _b === void 0 ? void 0 : _b.promise.reject(res.error);\n                  }\n                }\n              } catch (err) {\n                _iterator.e(err);\n              } finally {\n                _iterator.f();\n              }\n              promise.resolve(response);\n            case 14:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2, this);\n      }));\n    }\n  }, {\n    key: \"_abortAllRequests\",\n    value: function _abortAllRequests(msg) {\n      var _iterator2 = _createForOfIteratorHelper(this._requests.values()),\n        _step2;\n      try {\n        for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n          var promise = _step2.value.promise;\n          promise.reject(new OperationAbortError(msg));\n        }\n      } catch (err) {\n        _iterator2.e(err);\n      } finally {\n        _iterator2.f();\n      }\n    }\n  }]);\n  return Web3BatchRequest;\n}();","map":{"version":3,"names":["jsonRpc","Web3DeferredPromise","OperationAbortError","OperationTimeoutError","ResponseError","DEFAULT_BATCH_REQUEST_TIMEOUT","Web3BatchRequest","requestManager","_classCallCheck","_requestManager","_requests","Map","_createClass","key","get","_toConsumableArray","values","map","r","payload","value","add","request","toPayload","promise","set","id","execute","options","requests","length","_context","next","abrupt","Promise","resolve","timeout","_a","eagerStart","timeoutMessage","_processBatchRequest","catch","err","reject","_this","_abortAllRequests","stop","_callee","sendBatch","response","_context2","sent","size","concat","requestIds","Number","sort","a","b","responseIds","JSON","stringify","join","_iterator","_createForOfIteratorHelper","s","_step","n","done","res","isResponseWithResult","result","isResponseWithError","_b","error","e","f","_callee2","msg","_iterator2","_step2"],"sources":["D:\\projects\\react\\wen-base\\node_modules\\web3-core\\src\\web3_batch_request.ts"],"sourcesContent":["ï»¿/*\nThis file is part of web3.js.\n\nweb3.js is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nweb3.js is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with web3.js.  If not, see <http://www.gnu.org/licenses/>.\n*/\n\nimport { JsonRpcBatchResponse, JsonRpcOptionalRequest, JsonRpcRequest } from 'web3-types';\nimport { jsonRpc, Web3DeferredPromise } from 'web3-utils';\nimport { OperationAbortError, OperationTimeoutError, ResponseError } from 'web3-errors';\nimport { Web3RequestManager } from './web3_request_manager.js';\n\nexport const DEFAULT_BATCH_REQUEST_TIMEOUT = 1000;\n\nexport class Web3BatchRequest {\n\tprivate readonly _requestManager: Web3RequestManager;\n\tprivate readonly _requests: Map<\n\t\tnumber,\n\t\t{ payload: JsonRpcRequest; promise: Web3DeferredPromise<unknown> }\n\t>;\n\n\tpublic constructor(requestManager: Web3RequestManager) {\n\t\tthis._requestManager = requestManager;\n\t\tthis._requests = new Map();\n\t}\n\n\tpublic get requests() {\n\t\treturn [...this._requests.values()].map(r => r.payload);\n\t}\n\n\tpublic add<ResponseType = unknown>(request: JsonRpcOptionalRequest<unknown>) {\n\t\tconst payload = jsonRpc.toPayload(request) as JsonRpcRequest;\n\t\tconst promise = new Web3DeferredPromise<ResponseType>();\n\n\t\tthis._requests.set(payload.id as number, { payload, promise });\n\n\t\treturn promise;\n\t}\n\n\t// eslint-disable-next-line class-methods-use-this\n\tpublic async execute(options?: {\n\t\ttimeout?: number;\n\t}): Promise<JsonRpcBatchResponse<unknown, unknown>> {\n\t\tif (this.requests.length === 0) {\n\t\t\treturn Promise.resolve([]);\n\t\t}\n\n\t\tconst request = new Web3DeferredPromise<JsonRpcBatchResponse<unknown, unknown>>({\n\t\t\ttimeout: options?.timeout ?? DEFAULT_BATCH_REQUEST_TIMEOUT,\n\t\t\teagerStart: true,\n\t\t\ttimeoutMessage: 'Batch request timeout',\n\t\t});\n\n\t\tthis._processBatchRequest(request).catch(err => request.reject(err));\n\n\t\trequest.catch((err: Error) => {\n\t\t\tif (err instanceof OperationTimeoutError) {\n\t\t\t\tthis._abortAllRequests('Batch request timeout');\n\t\t\t}\n\n\t\t\trequest.reject(err);\n\t\t});\n\n\t\treturn request;\n\t}\n\n\tprivate async _processBatchRequest(\n\t\tpromise: Web3DeferredPromise<JsonRpcBatchResponse<unknown, unknown>>,\n\t) {\n\t\tconst response = await this._requestManager.sendBatch(\n\t\t\t[...this._requests.values()].map(r => r.payload),\n\t\t);\n\n\t\tif (response.length !== this._requests.size) {\n\t\t\tthis._abortAllRequests('Invalid batch response');\n\n\t\t\tthrow new ResponseError(\n\t\t\t\tresponse,\n\t\t\t\t`Batch request size mismatch the results size. Requests: ${this._requests.size}, Responses: ${response.length}`,\n\t\t\t);\n\t\t}\n\n\t\tconst requestIds = this.requests\n\t\t\t.map(r => r.id)\n\t\t\t.map(Number)\n\t\t\t.sort((a, b) => a - b);\n\n\t\tconst responseIds = response\n\t\t\t.map(r => r.id)\n\t\t\t.map(Number)\n\t\t\t.sort((a, b) => a - b);\n\n\t\tif (JSON.stringify(requestIds) !== JSON.stringify(responseIds)) {\n\t\t\tthis._abortAllRequests('Invalid batch response');\n\n\t\t\tthrow new ResponseError(\n\t\t\t\tresponse,\n\t\t\t\t`Batch request mismatch the results. Requests: [${requestIds.join()}], Responses: [${responseIds.join()}]`,\n\t\t\t);\n\t\t}\n\n\t\tfor (const res of response) {\n\t\t\tif (jsonRpc.isResponseWithResult(res)) {\n\t\t\t\tthis._requests.get(res.id as number)?.promise.resolve(res.result);\n\t\t\t} else if (jsonRpc.isResponseWithError(res)) {\n\t\t\t\tthis._requests.get(res.id as number)?.promise.reject(res.error);\n\t\t\t}\n\t\t}\n\n\t\tpromise.resolve(response);\n\t}\n\n\tprivate _abortAllRequests(msg: string) {\n\t\tfor (const { promise } of this._requests.values()) {\n\t\t\tpromise.reject(new OperationAbortError(msg));\n\t\t}\n\t}\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}